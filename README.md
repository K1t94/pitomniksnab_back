# GRAPHQL

## Установка

### Установить зависимости
```
yarn install
```

### Настроить параметры в файлах .env

Файлы `.env.development.local`, `.env.production.local` можно создавать локально, они игнорируются git.

Файлы `.env`, `.env.development` и `.env.production` **не изменять** без необходимости закомитить эти изменения.

**Параметры s3 хранилища для загруки файлов**
```
AWS_PROFILE
AWS_ACCESS_KEY_ID
AWS_SECRET_ACCESS_KEY
```

**Параметр префикс публичной ссылки до файлов**
```
PUBLIC_FILE_PREFIX
```

### Настроить параметры подключения к БД

Скопировать файл `ormconfig.json.dist` в `ormconfig.json` в нем заменить параметы подключения на актуальные. 

Файл ormconfig.json игнорируется git.  

### Обновление БД
При изменении схемы сущностей выполняются следующие команды:

**Создать пустой файл миграции**
```
yarn migrations:create -n %имя_миграции%
```

**Построение миграции с учетом изменений сущностей**
```
yarn migrations:diff -n %имя_миграции%
```

**Миграция текущего состояния схемы на сервере до актуальной**
```
yarn migrations:migrate
```

**Откатить состояние схемы на сервере до некой миграции**
```
yarn migrations:revert %до_какаой_миграции_откатить%
```

#### Важно!
1. миграции могут уничтожить данные в БД, так что смотри что запускаешь.
2. мигрыции не должны содержать данные для БД. Данные надо прикладывать дампами к репозиторию.

### Запуск

Development версия
```yarn start```

Production версия
```yarn start```

Production версия как демон на сервере
```pm2 start app-pm2.json```

При изменениях демона надо перезапускать
```pm2 restart graphql```